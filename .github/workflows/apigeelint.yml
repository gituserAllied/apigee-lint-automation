name: ApigeeLint Manual Bundle Scan

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/apigeelint.yml"
      - "sharedflows/**"
      - "apiproxy/**"

permissions:
  contents: write   # ‚úÖ Allow workflow to push commits to the repo

jobs:
  lint-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ‚úÖ ensure correct token used

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install ApigeeLint
        run: npm install -g apigeelint

      - name: Prepare Output Folders
        run: mkdir -p JsonFile ExcelFile

      - name: Run ApigeeLint on specific shared flow
        run: |
          echo "üîç Running ApigeeLint on specific shared flow bundle..."
          TARGET_PATH="${{ github.workspace }}/sharedflows/api_wise_spike_quota_rev23_2025_10_29/sharedflowbundle"
          if [ -d "$TARGET_PATH" ]; then
            echo "‚úÖ Found sharedflowbundle folder at: $TARGET_PATH"
            apigeelint -s "$TARGET_PATH" -f json.js -w "${{ github.workspace }}/JsonFile/api_wise_spike_quota_rev23_2025_10_29_report.json" || true
          else
            echo "‚ùå Shared flow bundle not found at $TARGET_PATH"
            exit 1
          fi

      - name: Show JSON Output
        run: |
          echo "üìÑ Checking generated JSON files..."
          ls -lh JsonFile || true
          echo ""
          for f in JsonFile/*.json; do
            echo "===== $f ====="
            cat "$f"
            echo ""
          done

      - name: Commit and Push JSON Output
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add JsonFile/*.json || true
          if ! git diff --cached --quiet; then
            git commit -m "Auto: Added ApigeeLint report for api_wise_spike_quota_rev23_2025_10_29"
            git push origin main
          else
            echo "‚ÑπÔ∏è No new JSON to commit."
          fi
