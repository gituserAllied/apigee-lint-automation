name: ApigeeLint Automation
 
on:
  push:
    branches:
      - main
    paths:
      - "apiproxy/**"
      - "sharedflows/**"
      - ".github/workflows/apigeelint.yml"
 
jobs:
  lint-and-report:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
 
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
 
      - name: Install ApigeeLint
        run: npm install -g apigeelint
 
      - name: Prepare Output Folders
        run: mkdir -p JsonFile ExcelFile
 
      - name: Detect Bundles to Lint
        id: detect
        run: |
          echo "üîé Detecting changed apiproxy/sharedflow bundles..."
          git fetch --depth=2 || true
          changed=$(git diff --name-only HEAD^ HEAD | grep -E '^(apiproxy|sharedflows)/' | cut -d/ -f1-2 | sort -u | uniq || true)
          if [ -z "$changed" ]; then
            echo "‚ö†Ô∏è No changed bundles found. Linting all top-level folders instead."
            find apiproxy sharedflows -mindepth 1 -maxdepth 1 -type d 2>/dev/null || true > changed.txt
            echo "run_lint=true" >> $GITHUB_ENV
          else
            echo "‚úÖ Found changed bundles:"
            echo "$changed"
            echo "$changed" > changed.txt
            echo "run_lint=true" >> $GITHUB_ENV
          fi
          echo ""
          echo "üëâ Contents of changed.txt:"
          cat changed.txt || echo "(empty)"
 
      - name: Run ApigeeLint
        if: env.run_lint == 'true'
        run: |
          echo "::remove-matcher owner=tsc::" || true
          echo "::remove-matcher owner=eslint-compact::" || true
 
          if [ ! -s changed.txt ]; then
            echo "‚ö†Ô∏è No bundles found to lint. Skipping..."
            exit 0
          fi
 
          while read bundle; do
            [ -z "$bundle" ] && continue
            echo "üß© Checking bundle: $bundle"
            if [ -d "$bundle/apiproxy" ]; then
              echo "üîç Running lint on API Proxy: $bundle/apiproxy"
              apigeelint -s "$bundle/apiproxy" -f json.js -w "JsonFile/${bundle//\//_}_proxy.json" || true
            elif [ -d "$bundle/sharedflowbundle" ]; then
              echo "üîç Running lint on Shared Flow: $bundle/sharedflowbundle"
              apigeelint -s "$bundle/sharedflowbundle" -f json.js -w "JsonFile/${bundle//\//_}_sf.json" || true
            else
              echo "‚ö†Ô∏è Skipping $bundle (no apiproxy/sharedflowbundle subdir found)"
            fi
          done < changed.txt
 
      - name: Show JSON Output
        if: env.run_lint == 'true'
        run: |
          echo "üìÑ Checking generated JSON files..."
          if [ "$(ls -A JsonFile 2>/dev/null)" ]; then
            ls -lh JsonFile
            echo ""
            echo "First few lines of each JSON file:"
            for f in JsonFile/*.json; do
              echo "===== $f ====="
              head -n 30 "$f" || true
              echo ""
            done
          else
            echo "‚ö†Ô∏è No JSON files found in JsonFile/"
          fi
 
      - name: Commit and Push JSON Output
        if: env.run_lint == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add JsonFile/*.json || true
          if ! git diff --cached --quiet; then
            git commit -m "Auto: Added ApigeeLint reports"
            git push
          else
            echo "‚ÑπÔ∏è No new JSON to commit."
          fi