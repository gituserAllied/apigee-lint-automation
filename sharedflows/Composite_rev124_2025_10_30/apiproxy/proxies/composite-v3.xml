<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ProxyEndpoint name="composite-v3">
    <Description/>
    <FaultRules/>
    <DefaultFaultRule name="all">
        <AlwaysEnforce>true</AlwaysEnforce>
        <Step>
            <Name>FC-ErrorHandling</Name>
        </Step>
    </DefaultFaultRule>
    <PreFlow name="PreFlow">
        <Request>
            <Step>
                <Name>SC-CaptureAnalytics</Name>
                <Condition>(request.verb != "OPTIONS")</Condition>
            </Step>
            <Step>
                <Name>JS-SetFlowType</Name>
            </Step>
            <Step>
                <Name>FC-AuthenticateRequest</Name>
                <Condition>(request.verb != "OPTIONS")</Condition>
            </Step>
            <Step>
                <Name>FC-QuotaSpike</Name>
            </Step>
            <Step>
                <Name>KVM-SpikeArrestLimit</Name>
                <Condition>(verifyapikey.VA-VerifyApiKey.enableRateLimit = "true")</Condition>
            </Step>
            <Step>
                <Name>SA-RateLimit</Name>
                <Condition>(verifyapikey.VA-VerifyApiKey.enableRateLimit = "true")</Condition>
            </Step>
            <Step>
                <Name>FC-Decryption</Name>
                <Condition>(request.verb != "OPTIONS") and (!(developer.app.name = "gpay")) and (!(developer.app.name = "Composite_Test"))</Condition>
                <!--<Condition>(request.verb != "OPTIONS") and (!(developer.app.name = "Composite_Test"))</Condition>-->
            </Step>
            <Step>
                <Name>FC-ThreatProtection</Name>
                <Condition>(request.verb != "OPTIONS")</Condition>
            </Step>
            <Step>
                <Name>JS-AllowedVersions</Name>
                <Condition>(verifyapikey.VA-VerifyApiKey.versionsAllowed != null)</Condition>
            </Step>
            <Step>
                <Name>RF-AllowedVersionsError</Name>
                <Condition>(verifyapikey.VA-VerifyApiKey.versionsAllowed != null and AllowedVersionErr == "0")</Condition>
            </Step>
            <Step>
                <Name>AM_setDecryptedClientRequestLog</Name>
            </Step>
        </Request>
        <Response>
            <Step>
                <Name>JS-AddErrorCode</Name>
            </Step>
            <Step>
                <Name>AM_DefaultClientResponseLog</Name>
            </Step>
            <Step>
                <Name>AM-SetResponse</Name>
            </Step>
            <Step>
                <Name>JS-AnalyticsLoggingDev</Name>
            </Step>
            <Step>
                <Name>FC-Encryption</Name>
                <Condition>(request.verb != "OPTIONS") and (!(developer.app.name = "gpay")) and (!(developer.app.name = "Composite_Test"))</Condition>
                <!--<Condition>(request.verb != "OPTIONS") and (!(developer.app.name = "Composite_Test"))</Condition>-->
            </Step>
            <Step>
                <Name>AM-AddCORS</Name>
            </Step>
        </Response>
    </PreFlow>
    <PostFlow name="PostFlow">
        <Request/>
        <Response/>
    </PostFlow>
    <PostClientFlow>
        <Request/>
        <Response>
            <Step>
                <Name>ML-MessageLogging</Name>
            </Step>
            <Step>
                <Name>ML-Test</Name>
                <Condition>(enableLogging = "true")</Condition>
            </Step>
        </Response>
    </PostClientFlow>
    <Flows>
        <Flow name="Transaction Status NEFT RTGS">
            <Description/>
            <Request>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/status/neft-rtgs") and (request.verb = "POST")</Condition>
        </Flow>
        <Flow name="Composite Process">
            <Description/>
            <Request>
                <Step>
                    <Name>JS-MIS-JSON-PCK</Name>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                </Step>
                <Step>
                    <Name>KVM-FetchInternalApiKey</Name>
                </Step>
                <Step>
                    <Name>SC-UPIBeneCheck</Name>
                    <Condition>validateBeneficiary = true and request.header.x-priority = "1000"</Condition>
                </Step>
                <Step>
                    <Name>SC-BeneficiaryCheck</Name>
                    <Condition>validateBeneficiary = true and request.header.x-priority != "1000"</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>validateBeneficiary = true</Condition>
                </Step>
                <Step>
                    <Name>SC-TransactionPriority</Name>
                    <Condition>(makeTransaction = true) or (isValidBeneficiary = true)</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>(makeTransaction = true) or (isValidBeneficiary = true)</Condition>
                </Step>
                <Step>
                    <Name>SC-BeneficiaryCheck</Name>
                    <Condition>(validateBeneficiary = true) and (isTransactionSuccessful = false)</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>(validateBeneficiary = true) and (isTransactionSuccessful = false)</Condition>
                </Step>
                <Step>
                    <Name>SC-TransactionPriority</Name>
                    <Condition>(isTransactionSuccessful = false) and (retry = true)</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>(isTransactionSuccessful = false) and (retry = true)</Condition>
                </Step>
                <Step>
                    <Name>SC-TransactionPriority</Name>
                    <Condition>(isTransactionSuccessful = false) and (retry = true)</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>(isTransactionSuccessful = false) and (retry = true)</Condition>
                </Step>
                <Step>
                    <Name>SC-TransactionPriority</Name>
                    <Condition>(isTransactionSuccessful = false) and (retry = true)</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>(isTransactionSuccessful = false) and (retry = true)</Condition>
                </Step>
                <Step>
                    <Name>SC-InsertToDatabase</Name>
                    <Condition>insertToDatabase = true</Condition>
                </Step>
                <Step>
                    <Name>JS-ValidateCompositeRequest</Name>
                    <Condition>insertToDatabase = true</Condition>
                </Step>
            </Request>
            <Response/>
            <Condition>(proxy.pathsuffix MatchesPath "/") and (request.verb = "POST")</Condition>
        </Flow>
    </Flows>
    <HTTPProxyConnection>
        <BasePath>/api/v3/composite-payment</BasePath>
        <Properties/>
        <VirtualHost>apibankingone</VirtualHost>
    </HTTPProxyConnection>
    <RouteRule name="NoRoute">
        <Condition>(proxy.pathsuffix MatchesPath "/") and (request.verb = "POST")</Condition>
    </RouteRule>
    <RouteRule name="L7-route">
        <TargetEndpoint>L7-route</TargetEndpoint>
        <Condition>(proxy.pathsuffix MatchesPath "/status/neft-rtgs")</Condition>
    </RouteRule>
    <!--<RouteRule name="default">
        <TargetEndpoint>default</TargetEndpoint>
    </RouteRule>-->
</ProxyEndpoint>