name: ApigeeLint Automation

on:
  push:
    branches:
      - main
    # Run only when files in these folders change
    paths:
      - "apiproxy/**"
      - "sharedflows/**"
      - ".github/workflows/apigeelint.yml"

jobs:
  lint-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install ApigeeLint
        run: npm install -g apigeelint

      - name: Prepare Output Folders
        run: mkdir -p JsonFile ExcelFile

      - name: Detect Changed Bundles
        id: detect
        run: |
          echo "Detecting changed apiproxy or sharedflow bundles..."
          changed=$(git diff --name-only HEAD^ HEAD | grep -E '^(apiproxy|sharedflows)/' | cut -d/ -f1-2 | sort -u | uniq || true)
          if [ -z "$changed" ]; then
            echo "No changed bundles found."
            echo "run_lint=false" >> $GITHUB_ENV
          else
            echo "Bundles changed:"
            echo "$changed"
            echo "$changed" > changed.txt
            echo "run_lint=true" >> $GITHUB_ENV
          fi

             - name: Run ApigeeLint
        if: env.run_lint == 'true'
        run: |
          echo "Running ApigeeLint for changed bundles..."
          while read bundle; do
            if [ -d "$bundle/apiproxy" ]; then
              echo "üîç Linting API Proxy: $bundle/apiproxy"
              apigeelint -s "$bundle/apiproxy" -f json.js -w "JsonFile/${bundle//\//_}_proxy_report.json" || true
            elif [ -d "$bundle/sharedflowbundle" ]; then
              echo "üîç Linting Shared Flow: $bundle/sharedflowbundle"
              apigeelint -s "$bundle/sharedflowbundle" -f json.js -w "JsonFile/${bundle//\//_}_sf_report.json" || true
            elif [ -d "$bundle" ]; then
              echo "üîç Attempting fallback lint for: $bundle"
              apigeelint -s "$bundle" -f json.js -w "JsonFile/${bundle//\//_}_fallback_report.json" || true
            else
              echo "‚ö†Ô∏è Skipping $bundle (no valid lintable path)"
            fi
          done < changed.txt

      - name: Show JSON Output
        if: env.run_lint == 'true'
        run: |
          echo "‚úÖ Lint completed. JSON reports generated:"
          ls -lh JsonFile
          echo ""
          for f in JsonFile/*.json; do
            echo "===== $f ====="
            cat "$f"
            echo ""
          done

      - name: Commit and Push JSON Output
        if: env.run_lint == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add JsonFile/*.json || true
          git commit -m "Auto: Added ApigeeLint reports" || echo "No new JSON to commit"
          git push
