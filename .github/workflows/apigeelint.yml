name: ApigeeLint Automation

on:
  push:
    branches:
      - main
    paths:
      - "apiproxy/**"
      - "sharedflows/**"

jobs:
  lint-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # important: fetch full history for git diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install ApigeeLint
        run: npm install -g apigeelint

      - name: Prepare folders
        run: mkdir -p JsonFile

      - name: Detect changed bundles
        id: detect
        run: |
          echo "ðŸ” Detecting changed apiproxy/sharedflow folders..."
          changed_paths=$(git diff --name-only HEAD^ HEAD | grep -E '^(apiproxy|sharedflows)/' | cut -d/ -f1-2 | sort -u || true)

          if [ -z "$changed_paths" ]; then
            echo "âš ï¸ No specific diff found, scanning all apiproxy/sharedflows folders..."
            changed_paths=$(find apiproxy sharedflows -mindepth 1 -maxdepth 1 -type d 2>/dev/null || true)
          fi

          echo "Changed or existing bundles:"
          echo "$changed_paths"
          echo "$changed_paths" > changed.txt

      - name: Run ApigeeLint
        run: |
          while read bundle; do
            if [ -d "$bundle/apiproxy" ]; then
              echo "ðŸš€ Linting API Proxy: $bundle"
              apigeelint -s "$bundle/apiproxy" -f json.js -w "JsonFile/${bundle//\//_}_report.json" || true
            else
              echo "ðŸš€ Linting Shared Flow: $bundle"
              apigeelint -s "$bundle" -f json.js -w "JsonFile/${bundle//\//_}_report.json" || true
            fi
          done < changed.txt

      - name: Show generated JSON
        run: |
          echo "ðŸ“ JSON Reports in JsonFile/:"
          ls -lh JsonFile || true
          echo ""
          for f in JsonFile/*.json; do
            echo "==== $f ===="
            cat "$f" || true
            echo ""
          done

      - name: Commit JSON Reports
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add JsonFile/*.json || true
          git commit -m "Auto: Added ApigeeLint reports" || echo "No new JSON to commit"
          git push
